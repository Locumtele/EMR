<iframe src="https://links.locumtele.org/widget/booking/mEx94HgKARvgePBFbzS0" 
        style="width: 100%;border:none;overflow: hidden;" 
        scrolling="no" 
        id="calendar-iframe">
</iframe>
<script src="https://links.locumtele.org/js/form_embed.js"></script>
<script>
(function() {
    let webhookTriggered = false;
    
    function getContactData() {
        const urlParams = new URLSearchParams(window.location.search);
        
        return {
            name: urlParams.get('contact_name') || '',
            email: urlParams.get('contact_email') || '',
            phone: urlParams.get('contact_phone') || '',
            state: (urlParams.get('contact_state') || '').toUpperCase(),
            address: urlParams.get('contact_address') || ''
        };
    }
    
    function getLocationId() {
        // Get from GHL merge tag - this should work since we're in the clinic's subaccount
        const locationId = '{{location.id}}';
        return locationId.includes('{{') ? '' : locationId;
    }
    
    const observer = new MutationObserver((mutations) => {
        if (webhookTriggered) return;
        
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1 && node.textContent && 
                    node.textContent.includes('Select a time')) {
                    
                    triggerWebhook();
                }
            });
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
    
    async function triggerWebhook() {
        if (webhookTriggered) return;
        webhookTriggered = true;
        
        const contactData = getContactData();
        const locationId = getLocationId();
        
        console.log('Sending to LocumTele webhook:', { contactData, locationId });
        
        const response = await fetch('https://locumtele.app.n8n.cloud/webhook/doctors-catalog', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                event: 'contact_form_completed',
                calendar_id: 'mEx94HgKARvgePBFbzS0',
                location_id: locationId,
                contact_data: contactData,
                timestamp: new Date().toISOString()
            })
        });
        
        console.log('Response:', response.status);
    }
})();
</script>
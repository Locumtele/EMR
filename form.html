<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Screening Form</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="form-container">
        <div class="title-box">
            <div id="dynamic-title">Loading Assessment...</div>
            <div class="subtitle">Complete your personalized health assessment</div>
        </div>
        <div id="loading" class="question-group loading">
            <h2>Loading Assessment...</h2>
            <p>Please wait while we load your screening questions</p>
        </div>
        <form id="form" class="form-content" style="display: none;">
            <div id="questions"></div>
        </form>
    </div>

    <script>
        const CONFIG = {
            screener: new URLSearchParams(window.location.search).get('screener') || 'GLP1',
            webhook: 'https://locumtele.app.n8n.cloud/webhook/notion-questions'
        };
        
        let currentQuestions = [];

        // Update page title and form title dynamically
        document.title = `${CONFIG.screener} Assessment`;
        document.getElementById('dynamic-title').textContent = `${CONFIG.screener} Assessment`;
        
        // Update subtitle based on screener type
        const categoryMap = {
            'GLP1': 'weight loss',
            'NAD': 'anti-aging',
            'Sermorelin': 'hormone optimization',
            'Testosterone': 'hormone optimization'
        };
        const category = categoryMap[CONFIG.screener] || 'health';
        document.querySelector('.subtitle').textContent = `Complete your personalized ${category} assessment`;

        async function loadQuestions() {
            try {
                const response = await fetch(CONFIG.webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ screenerType: CONFIG.screener, databaseId: '26e82abf7eae80f5ae8eeb0c7ecc76f0' })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const questions = data[0] ? JSON.parse(data[0].content).questions : null;
                
                if (!questions || questions.length === 0) {
                    throw new Error('No questions found in response');
                }
                
                currentQuestions = questions;
                buildForm(questions);
            } catch (error) {
                console.error('Error loading questions:', error);
                showErrorMessage(error.message);
            }
        }

        function showErrorMessage(errorMsg) {
            document.getElementById('loading').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <h2>Unable to Load Assessment</h2>
                    <p>There was a technical error loading your personalized questions.</p>
                    <p style="font-size: 14px; color: #666; margin-top: 20px;">Error: ${errorMsg}</p>
                    <button onclick="location.reload()" style="background: #000; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px;">Try Again</button>
                </div>
            `;
        }

        function getDefaultPlaceholder(type, text) {
            const lowerText = text.toLowerCase();
            if (lowerText.includes('name')) return 'Enter your full name';
            if (lowerText.includes('email')) return 'Enter your email address';
            if (lowerText.includes('phone')) return 'Enter your phone number';
            if (lowerText.includes('address')) return 'Enter your address';
            if (lowerText.includes('city')) return 'Enter city';
            if (lowerText.includes('state')) return 'Enter state';
            if (lowerText.includes('zip')) return 'Enter ZIP code';
            if (lowerText.includes('age')) return 'Enter your age';
            if (lowerText.includes('weight')) return 'Enter weight';
            if (lowerText.includes('height')) return 'Enter height';
            if (type === 'email') return 'Enter your email address';
            if (type === 'phone') return 'Enter your phone number';
            if (type === 'date') return 'MM/DD/YYYY';
            if (type === 'number') return 'Enter a number';
            return 'Enter your response';
        }


        function buildForm(questions) {
            const sections = {};
            questions.forEach(q => {
                if (!sections[q.section]) sections[q.section] = [];
                sections[q.section].push(q);
            });

            let html = '';
            Object.entries(sections).forEach(([section, qs]) => {
                html += `<div class="question-group"><div class="question-title">${section}</div>`;
                qs.forEach(q => {
                    // Check if this question should be conditionally shown
                    const isConditional = q.showCondition && q.showCondition !== 'always';
                    const conditionClass = isConditional ? `conditional-question-${q.id}` : '';
                    const conditionData = isConditional ? `data-show-if="${q.showCondition}"` : '';
                    const isInitiallyHidden = (isConditional && q.showCondition.includes('if_gender_female')) ? 'style="display: none;"' : '';
                    
                    // Start conditional wrapper if needed
                    if (isConditional) {
                        html += `<div class="conditional-question ${conditionClass}" ${conditionData} ${isInitiallyHidden}>`;
                    }
                    
                    // Build the question
                    html += `<div class="question"><label class="question-label">${q.text}</label>`;
                    
                    // Special handling for height/weight questions
                    if (q.text.toLowerCase().includes('height') && q.text.toLowerCase().includes('feet')) {
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                        html += '<div><label style="font-size: 14px; color: #666; margin-bottom: 5px; display: block;">Height (feet)</label><input class="text-input" type="number" name="height_feet" placeholder="5" min="3" max="8" onchange="calculateBMI()"></div>';
                        html += '<div><label style="font-size: 14px; color: #666; margin-bottom: 5px; display: block;">Height (inches)</label><input class="text-input" type="number" name="height_inches" placeholder="6" min="0" max="11" onchange="calculateBMI()"></div>';
                        html += '</div>';
                    } else if (q.text.toLowerCase().includes('weight') && q.text.toLowerCase().includes('pounds')) {
                        html += '<div><label style="font-size: 14px; color: #666; margin-bottom: 5px; display: block;">Weight (pounds)</label><input class="text-input" type="number" name="weight_pounds" placeholder="180" min="50" max="800" onchange="calculateBMI()"></div>';
                        html += '<div id="bmi-result" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>';
                    } else if (q.type === 'radio' || q.type === 'checkbox') {
                        html += '<div class="checkbox-group">';
                        [...new Set([...q.safe, ...q.flag, ...q.disqualify])].forEach(opt => {
                            html += `<div class="checkbox-option"><input type="checkbox" name="${q.id}" value="${opt}"><label>${opt.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label></div>`;
                        });
                        html += '</div>';
                    } else {
                        const placeholder = q.placeholder || getDefaultPlaceholder(q.type, q.text);
                        html += `<input class="text-input" type="${q.type}" name="${q.id}" placeholder="${placeholder}">`;
                    }
                    html += '</div>'; // Close question div
                    
                    // Close conditional wrapper if needed
                    if (isConditional) {
                        html += '</div>';
                    }
                });
                
                // Add submit button to the last section
                if (section === Object.keys(sections)[Object.keys(sections).length - 1]) {
                    html += '<div style="text-align: center; margin-top: 20px;"><button type="submit" class="nav-button">SUBMIT ASSESSMENT</button></div>';
                }
                
                html += '</div>';
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            document.getElementById('questions').innerHTML = html;
            
            // Add conditional logic for showing/hiding questions
            setupConditionalLogic();
        }

        function setupConditionalLogic() {
            // Handle all conditional questions based on showCondition from Notion
            const conditionalQuestions = document.querySelectorAll('[data-show-if]');
            
            conditionalQuestions.forEach(question => {
                const condition = question.getAttribute('data-show-if');
                
                if (condition === 'if_gender_female') {
                    const genderInputs = document.querySelectorAll('input[name="5"]'); // Gender question ID
                    
                    genderInputs.forEach(input => {
                        input.addEventListener('change', function() {
                            if (this.value === 'female' && this.checked) {
                                question.style.display = 'block';
                            } else {
                                question.style.display = 'none';
                            }
                        });
                    });
                }
                // Add more conditions as needed based on your Notion data
                // e.g., if_tobacco_yes, if_diabetes_yes, etc.
            });
        }

        function validateForm() {
            const errors = [];
            const formData = new FormData(document.getElementById('form'));
            
            // Properly collect all form data, especially for checkboxes
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    // If key already exists, convert to array or add to array
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }
            
            console.log('Form data collected:', data); // Debug log
            
            // Check required fields
            const requiredFields = ['1', '2', '3', '4', '5']; // Full name, email, phone, DOB, gender
            
            requiredFields.forEach(fieldId => {
                const value = data[fieldId];
                if (!value || value.trim() === '') {
                    const fieldName = getFieldName(fieldId);
                    errors.push(`${fieldName} is required`);
                }
            });
            
            // Validate email format
            if (data['2'] && !isValidEmail(data['2'])) {
                errors.push('Please enter a valid email address');
            }
            
            // Validate phone format
            if (data['3'] && !isValidPhone(data['3'])) {
                errors.push('Please enter a valid phone number');
            }
            
            // Validate age (must be 18+)
            if (data['4']) {
                const age = calculateAge(data['4']);
                if (age < 18) {
                    errors.push('You must be 18 years or older to use this service');
                }
            }

            // Check BMI disqualification
            const bmiResult = document.getElementById('bmi-result');
            if (bmiResult && bmiResult.getAttribute('data-disqualified') === 'true') {
                errors.push('BMI requirement not met. This program requires a BMI of 25 or higher.');
            }

            // Check for disqualifying conditions using Notion data
            const disqualificationResult = checkDisqualifyingConditions(data, currentQuestions);
            if (disqualificationResult.disqualified) {
                errors.push(disqualificationResult.message);
            }

            return errors;
        }

        function checkDisqualifyingConditions(data, questions) {
            console.log('Checking disqualifying conditions...');
            console.log('Questions with disqualify arrays:', questions.filter(q => q.disqualify && q.disqualify.length > 0));
            
            // Check each question for disqualifying responses
            for (let question of questions) {
                const questionId = question.id.toString();
                const userResponse = data[questionId];
                
                console.log(`Question ${questionId} (${question.text}):`, {
                    userResponse,
                    disqualify: question.disqualify,
                    disqualifyMessage: question.disqualifyMessage
                });
                
                if (!userResponse || !question.disqualify || question.disqualify.length === 0) {
                    continue;
                }
                
                // Check if user selected any disqualifying options
                const selectedOptions = Array.isArray(userResponse) ? userResponse : [userResponse];
                const hasDisqualifyingResponse = selectedOptions.some(response => 
                    question.disqualify.includes(response)
                );
                
                console.log(`Question ${questionId} - Selected options:`, selectedOptions);
                console.log(`Question ${questionId} - Disqualifying options:`, question.disqualify);
                console.log(`Question ${questionId} - Has disqualifying response:`, hasDisqualifyingResponse);
                
                if (hasDisqualifyingResponse && question.disqualifyMessage) {
                    console.log(`DISQUALIFIED by question ${questionId}:`, question.disqualifyMessage);
                    return {
                        disqualified: true,
                        message: question.disqualifyMessage
                    };
                }
            }
            
            console.log('No disqualifying conditions found');
            return { disqualified: false, message: '' };
        }
        
        function getFieldName(fieldId) {
            const fieldNames = {
                '1': 'Full Name',
                '2': 'Email Address', 
                '3': 'Phone Number',
                '4': 'Date of Birth',
                '5': 'Gender'
            };
            return fieldNames[fieldId] || 'Field';
        }
        
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function isValidPhone(phone) {
            return /^[\+]?[1-9][\d]{0,15}$/.test(phone.replace(/[\s\-\(\)]/g, ''));
        }
        
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function calculateBMI() {
            const heightFeet = document.querySelector('input[name="height_feet"]')?.value;
            const heightInches = document.querySelector('input[name="height_inches"]')?.value;
            const weightPounds = document.querySelector('input[name="weight_pounds"]')?.value;
            const resultDiv = document.getElementById('bmi-result');

            if (!heightFeet || !heightInches || !weightPounds || !resultDiv) {
                return;
            }

            // Convert height to total inches
            const totalInches = (parseInt(heightFeet) * 12) + parseInt(heightInches);

            // Calculate BMI: (weight in pounds / (height in inches)²) × 703
            const bmi = (parseFloat(weightPounds) / (totalInches * totalInches)) * 703;

            if (isNaN(bmi) || bmi <= 0) {
                resultDiv.style.display = 'none';
                return;
            }

            resultDiv.style.display = 'block';

            if (bmi < 25) {
                resultDiv.innerHTML = `
                    <div style="background: #fee; border: 1px solid #fcc; color: #c33;">
                        <strong>BMI: ${bmi.toFixed(1)}</strong><br>
                        Unfortunately, this program requires a BMI of 25 or higher. You may not be eligible for this treatment.
                    </div>
                `;
                resultDiv.setAttribute('data-disqualified', 'true');
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #efe; border: 1px solid #cfc; color: #363;">
                        <strong>BMI: ${bmi.toFixed(1)}</strong><br>
                        Great! You meet the BMI requirement for this program.
                    </div>
                `;
                resultDiv.setAttribute('data-disqualified', 'false');
            }
        }

        function showDisqualificationScreen(message) {
            document.getElementById('form').style.display = 'none';
            document.getElementById('loading').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <div style="background: #fee; border: 2px solid #fcc; border-radius: 12px; padding: 30px; margin: 20px 0;">
                        <h2 style="color: #c33; margin-bottom: 20px;">Assessment Complete</h2>
                        <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">${message}</p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 25px;">
                            We recommend discussing your health goals with your primary care physician or a specialist who can provide personalized guidance.
                        </p>
                        <button onclick="location.reload()" style="background: #000; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Start Over
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('loading').style.display = 'block';
        }

        document.getElementById('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate form
            const errors = validateForm();
            if (errors.length > 0) {
                // Check if it's a disqualification error
                const disqualificationError = errors.find(error => 
                    error.includes('GLP-1 medications') || 
                    error.includes('BMI requirement') ||
                    error.includes('safety') ||
                    error.includes('not recommended')
                );
                
                if (disqualificationError) {
                    showDisqualificationScreen(disqualificationError);
                    return;
                }
                
                alert('Please fix the following errors:\n\n' + errors.join('\n'));
                return;
            }
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                await fetch('https://locumtele.app.n8n.cloud/webhook/patient-screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ form_type: CONFIG.screener, responses: data })
                });
                
                const event = new CustomEvent('ghlRedirect', { detail: { category: 'weightloss', formType: CONFIG.screener.toLowerCase() } });
                window.dispatchEvent(event);
            } catch (error) {
                alert('Error submitting form. Please try again.');
            }
        });

        loadQuestions();
    </script>
</body>
</html>

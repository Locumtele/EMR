<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Screening Form</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="form-container">
        <div class="title-box">
            <div id="dynamic-title">Loading Assessment...</div>
            <div class="subtitle">Complete your personalized health assessment</div>
        </div>
        <div id="loading" class="question-group loading">
            <h2>Loading Assessment...</h2>
            <p>Please wait while we load your screening questions</p>
        </div>
        <form id="form" class="form-content" style="display: none;">
            <div id="questions"></div>
        </form>
    </div>

    <script>
        const CONFIG = {
            screener: new URLSearchParams(window.location.search).get('screener') || 'GLP1',
            webhook: 'https://locumtele.app.n8n.cloud/webhook/notion-questions'
        };

        // Update page title and form title dynamically
        document.title = `${CONFIG.screener} Assessment`;
        document.getElementById('dynamic-title').textContent = `${CONFIG.screener} Assessment`;
        
        // Update subtitle based on screener type
        const categoryMap = {
            'GLP1': 'weight loss',
            'NAD': 'anti-aging',
            'Sermorelin': 'hormone optimization',
            'Testosterone': 'hormone optimization'
        };
        const category = categoryMap[CONFIG.screener] || 'health';
        document.querySelector('.subtitle').textContent = `Complete your personalized ${category} assessment`;

        async function loadQuestions() {
            try {
                const response = await fetch(CONFIG.webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ screenerType: CONFIG.screener, databaseId: '26e82abf7eae80f5ae8eeb0c7ecc76f0' })
                });
                
                const data = await response.json();
                const questions = data[0] ? JSON.parse(data[0].content).questions : getSampleQuestions();
                buildForm(questions);
            } catch (error) {
                console.error('Error:', error);
                buildForm(getSampleQuestions());
            }
        }

        function getSampleQuestions() {
            return [
                { id: 1, section: 'Patient Profile', text: 'Full Name', type: 'text', safe: ['any_text'] },
                { id: 2, section: 'Patient Profile', text: 'Email Address', type: 'email', safe: ['any_email'] },
                { id: 3, section: 'Patient Profile', text: 'Phone Number', type: 'phone', safe: ['any_phone'] },
                { id: 4, section: 'Patient Profile', text: 'Date of Birth', type: 'date', safe: ['18+ years old'] },
                { id: 5, section: 'Patient Profile', text: 'Gender', type: 'radio', safe: ['male', 'female'] }
            ];
        }

        function buildForm(questions) {
            const sections = {};
            questions.forEach(q => {
                if (!sections[q.section]) sections[q.section] = [];
                sections[q.section].push(q);
            });

            let html = '';
            Object.entries(sections).forEach(([section, qs]) => {
                html += `<div class="question-group"><div class="question-title">${section}</div>`;
                qs.forEach(q => {
                    html += `<div class="question"><label class="question-label">${q.text}</label>`;
                    
                    // Special handling for height/weight questions
                    if (q.text.toLowerCase().includes('height') && q.text.toLowerCase().includes('feet')) {
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
                        html += '<div><label style="font-size: 14px; color: #666; margin-bottom: 5px; display: block;">Height (feet)</label><input class="text-input" type="number" name="height_feet" placeholder="5" min="3" max="8"></div>';
                        html += '<div><label style="font-size: 14px; color: #666; margin-bottom: 5px; display: block;">Height (inches)</label><input class="text-input" type="number" name="height_inches" placeholder="6" min="0" max="11"></div>';
                        html += '</div>';
                    } else if (q.text.toLowerCase().includes('weight') && q.text.toLowerCase().includes('pounds')) {
                        html += '<div><label style="font-size: 14px; color: #666; margin-bottom: 5px; display: block;">Weight (pounds)</label><input class="text-input" type="number" name="weight_pounds" placeholder="180" min="50" max="800"></div>';
                    } else if (q.type === 'radio') {
                        html += '<div class="checkbox-group">';
                        [...new Set([...q.safe, ...q.flag, ...q.disqualify])].forEach(opt => {
                            html += `<div class="checkbox-option"><input type="checkbox" name="${q.id}" value="${opt}"><label>${opt.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label></div>`;
                        });
                        html += '</div>';
                    } else if (q.type === 'checkbox') {
                        html += '<div class="checkbox-group">';
                        [...new Set([...q.safe, ...q.flag, ...q.disqualify])].forEach(opt => {
                            html += `<div class="checkbox-option"><input type="checkbox" name="${q.id}" value="${opt}"><label>${opt.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label></div>`;
                        });
                        html += '</div>';
                    } else {
                        html += `<input class="text-input" type="${q.type}" name="${q.id}" placeholder="${q.placeholder || ''}">`;
                    }
                    html += '</div>';
                });
                
                // Add submit button to the last section
                if (section === Object.keys(sections)[Object.keys(sections).length - 1]) {
                    html += '<div style="text-align: center; margin-top: 20px;"><button type="submit" class="nav-button">SUBMIT ASSESSMENT</button></div>';
                }
                
                html += '</div>';
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            document.getElementById('questions').innerHTML = html;
        }

        document.getElementById('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                await fetch('https://locumtele.app.n8n.cloud/webhook/patient-screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ form_type: CONFIG.screener, responses: data })
                });
                
                const event = new CustomEvent('ghlRedirect', { detail: { category: 'weightloss', formType: CONFIG.screener.toLowerCase() } });
                window.dispatchEvent(event);
            } catch (error) {
                alert('Error submitting form. Please try again.');
            }
        });

        loadQuestions();
    </script>
</body>
</html>
